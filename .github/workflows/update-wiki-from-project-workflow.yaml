name: "Update US table in Wiki"
on:
  workflow_call:
    inputs:
      org:
        required: true
        type: string
      project_number:
        required: true
        type: string
      wiki_page:
        required: true
        type: string
      marker_prefix:
        required: false
        type: string
        default: "US_TABLE"
      profile_label:
        required: true
        type: string
      epic_label:
        required: true
        type: string

jobs:
  update-wiki:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - id: app
        name: ğŸ” GitHub App token
        uses: avenirs-esr/avenirs-workflows/.github/actions/github-app-token@main
        with:
          app_id: ${{ secrets.WIKI_APP_ID }}
          app_private_key: ${{ secrets.WIKI_APP_TOKEN }}
          owner: ${{ inputs.org }}

      - name: âœï¸ Generate table (US)
        uses: avenirs-esr/avenirs-workflows/.github/actions/project-to-markdown@main
        with:
          token:          ${{ steps.app.outputs.app-token }}
          org:            ${{ inputs.org }}
          project_number: ${{ inputs.project_number }}
          profile_label:   ${{ inputs.profile_label }}
          epic_label:     ${{ inputs.epic_label }}
          out_file:       US_TABLE.md

      - name: ğŸ“¥ Clone wiki of caller repo
        env:
          TOKEN: ${{ steps.app.outputs.app-token }}
        run: |
          git config --global user.name  "${{ steps.app.outputs.app-slug || 'avenirs-wiki-bot' }}[bot]"
          git config --global user.email "${{ steps.app.outputs.app-slug || 'avenirs-wiki-bot' }}[bot]@users.noreply.github.com"
          git clone "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki

      - name: ğŸ”„ï¸ Replace section in page
        uses: avenirs-esr/avenirs-workflows/.github/actions/wiki-replace-section@feat/522-wiki-automation
        with:
          marker_prefix: ${{ inputs.marker_prefix }}
          wiki_page:   wiki/${{ inputs.wiki_page }}
          tables_dir: epic_tables
          create_missing_section: "false"

      - name: ğŸ“¤ Commit & push
        working-directory: wiki
        run: |
          git add "${{ inputs.wiki_page }}"
                git commit -m "chore(wiki): update US table" || echo "No changes"
                git push
