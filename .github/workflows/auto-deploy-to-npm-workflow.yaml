name: Autodeploy to npm (no need to run it)

on:
  workflow_call:

jobs:
  publish-to-npm:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        task: [build, typecheck, lint, build]
        include:
          - task: build
            name: ğŸ—ï¸ Build project
            cmd: "npm run build-only"
          - task: typecheck
            name: ğŸ§  TypeScript type checking
            cmd: "npm run type-check"
          - task: lint
            name: ğŸ§¹ Run ESLint
            cmd: "npm run lint"
          - task: build
            name: ğŸ—ï¸ Build package
            cmd: "npm run build"

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Verify tag is on develop
        run: |
          TAG_REF=${GITHUB_REF#refs/tags/}
          COMMIT=$(git rev-list -n 1 $TAG_REF)
          echo "Tag $TAG_REF points to commit $COMMIT"

          BRANCHES=$(git branch -r --contains $COMMIT | grep 'origin/develop' || true)
          if [ -z "$BRANCHES" ]; then
            echo "âŒ Tag $TAG_REF is not on develop, skipping publish."
            exit 1
          fi

          echo "âœ… Tag $TAG_REF is on develop"

      - name: ğŸ”§ Setup Node + install
        uses: avenirs-esr/avenirs-workflows/.github/actions/setup-node@feat/539-frontend-workflows

      - name: ${{ matrix.name }}
        run: ${{ matrix.cmd }}

      - name: ğŸš€ Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
