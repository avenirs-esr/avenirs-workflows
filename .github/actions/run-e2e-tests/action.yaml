name: Run E2E Tests
description: Run Playwright E2E tests for frontend projects

inputs:
  base_url:
    description: Base URL for e2e tests
    required: false
    default: 'http://localhost:4173/cofolio/'
  username:
    description: Username for authentication (not used for now)
    required: false
  password:
    description: Password for authentication (not used for now)
    required: false
  enable_msw:
    description: Enable MSW mocking
    required: false
    default: 'true'
  upload_report:
    description: Upload Playwright report as artifact
    required: false
    default: 'true'
  run_local_preview:
    description: Build and run local preview server before e2e tests
    required: false
    default: 'false'
  chrome_only:
    description: Run e2e tests only on Chrome (faster)
    required: false
    default: 'false'
  review_mode:
    description: Enable review mode to skip tests for features hidden in demo mode
    required: false
    default: 'true'

runs:
  using: composite
  steps:
    - name: ğŸ—ï¸ Build project (skip type-check for e2e)
      if: ${{ inputs.run_local_preview == 'true' }}
      shell: bash
      run: npm run build-only:development
      env:
        VITE_ENABLE_MSW: ${{ inputs.enable_msw }}

    - name: ğŸš€ Start preview server
      if: ${{ inputs.run_local_preview == 'true' }}
      shell: bash
      run: npm run preview:development &

    - name: â³ Wait for preview server
      if: ${{ inputs.run_local_preview == 'true' }}
      shell: bash
      run: |
        echo "Waiting for preview server to be ready..."
        timeout 60 bash -c 'until curl -s ${{ inputs.base_url }} > /dev/null 2>&1; do sleep 1; done'
        echo "Preview server is ready!"

    - name: ğŸ“¦ Install e2e dependencies
      shell: bash
      working-directory: e2e
      run: npm ci

    - name: ğŸ” Get Playwright version
      id: playwright-version
      shell: bash
      working-directory: e2e
      run: echo "version=$(npx playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

    - name: ğŸ—„ï¸ Cache Playwright browsers
      id: playwright-cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

    - name: ğŸ­ Install Playwright browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      shell: bash
      working-directory: e2e
      run: npm run e2e:install

    - name: ğŸ­ Install Playwright system dependencies
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      shell: bash
      working-directory: e2e
      run: npx playwright install-deps

    - name: ğŸ§ª Run e2e tests
      id: e2e_tests
      shell: bash
      working-directory: e2e
      timeout-minutes: 30
      run: ${{ inputs.chrome_only == 'true' && 'npm run e2e:chrome' || 'npm run e2e' }}
      env:
        CI: 'true'
        VITE_API_URL: ${{ inputs.base_url }}
        USERNAME: ${{ inputs.username }}
        PASSWORD: ${{ inputs.password }}
        REVIEW_MODE: ${{ inputs.review_mode }}

    - name: ğŸ“¦ Upload Playwright Report
      if: ${{ always() && inputs.upload_report == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: e2e/playwright-report
        if-no-files-found: ignore
        retention-days: 7
