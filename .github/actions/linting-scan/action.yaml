name: "Code Formatting (Java, JavaScript, TypeScript)"
description: "V√©rifie si le code Java, JavaScript et TypeScript est correctement format√© sans le modifier automatiquement"
inputs:
  fail_if_unformatted:
    description: "Echoue si du code n'est pas correctement format√© (true/false)"
    required: false
    default: "true"
runs:
  using: "composite"
  steps:
    - name: üíª Detect Project Type
      id: detect_project_type
      uses: avenirs-esr/avenirs-workflows/.github/actions/detect-project-type@feat/core-actions-workflows

    - name: üìú Initialize HTML Report
      if: env.project_type == 'java'
      run: |
        mkdir -p lint
        echo "<html><head><title>Linting Report</title></head><body>" > lint/formatting-report.html
      shell: bash

    - name: üîß Install Google Java Format (Java)
      if: env.project_type == 'java'
      uses: avenirs-esr/avenirs-workflows/.github/actions/setup-google-java-format@feat/core-actions-workflows

    - name: üîé Check Java Code Formatting (google-java-format)
      if: env.project_type == 'java'
      run: |
        echo "V√©rification du format Java avec Google Java Format..."
        echo "<h2>V√©rification du format Java</h2><ul>" >> lint/formatting-report.html
        has_unformatted=false

        for file in $(git ls-files -- '*.java'); do
            echo "V√©rification du format : $file"
            if ! java -jar google-java-format.jar --dry-run --set-exit-if-changed "$file"; then
              echo "‚ùå Fichier mal format√© : $file"
              git diff -- "$file" || true
              has_unformatted=true

              echo "<li><strong>$file</strong><pre>" >> lint/formatting-report.html
              git diff -- "$file" >> lint/formatting-report.html
            fi
          done

        if [ "$has_unformatted" = true ]; then
          echo "</ul><p><strong>üö´ Des fichiers Java sont mal format√©s.</strong></p></body></html>" >> lint/formatting-report.html
          exit 1
        else
          echo "</ul><p><strong>‚úÖ Tout le code Java est correctement format√©.</strong></p></body></html>" >> lint/formatting-report.html
        fi
      shell: bash

    - name: üîß Set up Node.js 22 and install dependencies
      if: env.project_type == 'node'
      uses: avenirs-esr/avenirs-workflows/.github/actions/setup-node@feat/core-actions-workflows

    - name: üßπ Run ESLint
      if: env.project_type == 'node'
      run: |
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
          echo "Running ESLint..."
          npm run lint
        else
          echo "ESLint configuration not found. Skipping."
        fi
      shell: bash
